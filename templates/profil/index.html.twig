{% extends 'base.html.twig' %}

{% block title %}Profil de {{ app.user.prenom }} {{ app.user.nomUser }}{% endblock %}


{% block body %}


<div class="container bg-light mt-4">
    <h2 class="text-center mb-4">Profil de {{ app.user.prenom }} {{ app.user.nomUser }}</h2>

<div class="accordion" id="profilAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingInformations">
            <button class="accordion-button bg-primary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInformations" aria-expanded="true" aria-controls="collapseInformations">
                Informations personnelles
            </button>
        </h2>
        <div id="collapseInformations" class="accordion-collapse collapse show" aria-labelledby="headingInformations" data-bs-parent="#profilAccordion">
            <div class="accordion-body">
                {% if 'ROLE_ADMIN' in app.user.roles %}
                    <p class="text-success mt-1">Bienvenue administrateur ! Vous avez acc√®s √† toutes les fonctionnalit√©s.</p>
                {% elseif 'ROLE_TECHNICIEN' in app.user.roles %}
                    <p class="text-primary mt-1">Bienvenue technicien ! Vous pouvez g√©rer les interventions.</p>
                {% elseif 'ROLE_BENEVOLE' in app.user.roles %}
                    <p class="text-info mt-1">Bienvenue b√©n√©vole ! Merci pour votre engagement.</p>
                {% else %}
                    <p class="text-muted mt-1">R√¥le non reconnu.</p>
                {% endif %}

                <div class="row mt-1">
                    <p class="col"><strong>Nom :</strong> {{ app.user.nomUser }}</p>
                    <p class="col"><strong>Pr√©nom :</strong> {{ app.user.prenom }}</p>
                    <p class="col"><strong>Email :</strong> {{ app.user.email }}</p>
                    <p class="col"><strong>R√¥le :</strong> {{ app.user.role.roleName }}</p>
                </div>

                <div class="d-flex flex-wrap justify-content-center gap-3 mt-3">
                    <a href="{{ path('profil_edit_photo') }}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Modifier la photo
                    </a>

                </div>

            </div>
                    {% if 'ROLE_ADMIN' in app.user.roles %}
                    <div class="row">

                        <a href="{{ path('admin_dashboard') }}" class="col ms-2 btn btn-danger ">
                            <i class="bi bi-tools"></i> Acc√®s √† l‚Äôadministration
                        </a>

                        <a href="{{ path('user_dashboard') }}" class="col ms-2 me-2 btn btn-primary">
                            <i class="bi bi-bar-chart-line"></i> Acc√©der au Dashboard Utilisateur
                        </a>
                    </div>    
                    {% endif %}

        </div>
    </div>
</div>
    <h3 class="mt-5 text-center"><i class="bi bi-clipboard-data"></i> Interventions effectu√©es</h3>
        
{% if interventions is empty %}
    <p class="text-muted text-center">Aucune intervention enregistr√©e.
    <a href="{{ path('app_profil', {'view': view}) }}" class="btn btn-outline-warning" title="R√©initialiser Filtre">
                ‚ôªÔ∏è
            </a></p>
{% else %}

    {% if 'ROLE_ADMIN' in app.user.roles %}
        <div class="d-flex justify-content-center my-3 gap-2">
            <a href="{{ path('app_profil', {'view': 'mine'}) }}" class="btn btn-outline-primary {{ view == 'mine' ? 'active' : '' }}">
                üôã‚Äç‚ôÇÔ∏è Mes interventions
            </a>
            <a href="{{ path('app_profil', {'view': 'all'}) }}" class="btn btn-outline-success {{ view == 'all' ? 'active' : '' }}">
                üë• Toutes les interventions
            </a>
        </div>
    {% endif %}

    <p class="text-center mb-4">
        {% if 'ROLE_ADMIN' in app.user.roles %}
            {% if view == 'all' %}
                <span class="text-success fw-bold">üë• Affichage de toutes les interventions (admin)</span>
            {% else %}
                <span class="text-info fw-bold">üôã‚Äç‚ôÇÔ∏è Affichage de vos interventions uniquement</span>
            {% endif %}
        {% endif %}    
    </p>

        {# ‚úÖ R√©sum√© statistique global #}
            <div class="alert alert-light border shadow-sm p-3 mb-4">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h5 class="text-primary">
                            <i class="bi bi-eye-fill"></i> 
                            {{ interventions|length }} affich√©e{{ interventions|length > 1 ? 's' : '' }}
                        </h5>
                        {% if start or end %}
                            <p class="mb-0 small text-muted">
                                üîç Filtr√©es 
                                {% if start %} depuis le <strong>{{ start|date('d/m/Y') }}</strong>{% endif %}
                                {% if end %} jusqu‚Äôau <strong>{{ end|date('d/m/Y') }}</strong>{% endif %}
                            </p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-success">
                            <i class="bi bi-database-check"></i> 
                            {{ totalInterventions }} intervention{{ totalInterventions > 1 ? 's' : '' }} au total
                        </h5>
                    </div>
                    <div class="col-md-4">
                        <h5 class="text-info">
                            <i class="bi bi-people-fill"></i> 
                            {{ allIntervenants|length }} intervenant{{ allIntervenants|length > 1 ? 's' : '' }}
                        </h5>
                    </div>
                </div>
            </div>

<div class="align-items-center">
    <form method="get" action="{{ path('app_profil') }}" class="row g-2 mb-3 align-items-center">
        <input type="hidden" name="view" value="{{ view }}">

        <div class="col-md-3 mt-3">
            <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="üîç Mod√®le, Cat√©gorie...">
        </div>

        {% if 'ROLE_ADMIN' in app.user.roles %}
            <div class="col-md-3 mt-3">
                <select name="intervenant" class="form-select">
                    <option value="">üë§ Tous les intervenants</option>
                    {% for u in allIntervenants %}
                        {% set nomComplet = u.prenom ~ ' ' ~ u.nomUser %}
                        <option value="{{ nomComplet }}" {{ intervenant == nomComplet ? 'selected' : '' }}>
                            {{ nomComplet }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        {%endif%}        

        <div class="col-md-2 mt-3" style="font-size: 1rem">
            <input type="date" name="start" value="{{ start }}" class="form-control" title="üìÖ D√©but">
        </div>

        <div class="col-md-2 mt-3">
            <input type="date" name="end" value="{{ end }}" class="form-control" title="üìÖ Fin">
        </div>

        <div class="col-md-1 mt-3">
            <button class="btn btn-primary" type="submit" title="Filtrer">üîé</button>
        </div>

        <div class="col-md-1 mt-3">
            <a href="{{ path('app_profil', {'view': view}) }}" class="btn btn-outline-secondary" title=" R√©initialiser Filtre">
                ‚ôªÔ∏è
            </a>
        </div>
        
    </form>

    <div class="d-flex justify-content-end mb-3 gap-2">
        <a href="{{ path('export_interventions_pdf', {'view': view, 'search': search, 'start': start, 'end': end}) }}" class="btn btn-outline-danger" title="Exporter en PDF">
            üìÑ
        </a>
        <a href="{{ path('export_interventions_excel', {'view': view, 'search': search, 'start': start, 'end': end}) }}" class="btn btn-outline-success" title="Exporter en Excel">
            üìä
        </a>
    </div>
    
</div>

    <div>
        {% if 'ROLE_ADMIN' in app.user.roles %} <!-- V√©rification du r√¥le admin -->
            <form id="delete-form" method="post" action="{{ path('intervention_delete_multiple') }}"> <!-- Formulaire pour la suppression multiple -->
                <input type="hidden" name="_token" value="{{ csrf_token('delete_multiple') }}">
            {% endif %}
            <table class="table table-striped" id="interventions-table"> <!-- ID de la table pour DataTables -->
                <thead class="table-dark">
                    <tr style="color: #61a444">
                        {% if 'ROLE_ADMIN' in app.user.roles %}
                            <th><input type="checkbox" id="select-all"></th>
                        {% endif %}
                        <th class="text-center">ID</th> 
                        <th class="text-center">Intervenant</th>
                        <th class="text-center">Produit</th>
                        <th class="text-center">Code Barre</th>
                        <th class="text-center">Date</th>
                        <th class="text-center">Commentaire</th>
                        <th class="text-center">Fiche</th>
                    </tr>
                </thead>
                <tbody>
                    {% for intervention in interventions %} <!-- Boucle sur les interventions -->
                        <tr>
                            {% if 'ROLE_ADMIN' in app.user.roles %}
                                <td><input type="checkbox" name="ids[]" value="{{ intervention.id }}"></td>
                            {% endif %}
                            <td>{{ intervention.id }}</td>
                            <td>{{ intervention.intervenant.prenom }} {{ intervention.intervenant.nomUser }}</td> 
                            <td>
                                {% if intervention.produit %}
                                    {{ intervention.produit.categorie.nom ?? 'N/A' }} - {{ intervention.produit.marque ?? 'N/A' }} - {{ intervention.produit.modele ?? 'N/A' }}
                                {% else %}
                                    <span class="text-muted">Produit non trouv√©</span>
                                {% endif %}
                            </td>
                            <td>{{ intervention.codeBarre }}</td> 
                            <td>{{ intervention.dateIntervention|date('d/m/Y') }}</td>
                            <td>{{ intervention.commentaire }}</td>
                            <td>
                                
                                    <a href="{{ path('intervention_show', { id: intervention.id }) }}" class="btn btn-sm btn-info" title="Afficher la fiche intervention">
                                        üëÅ
                                    </a>
                               
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if 'ROLE_ADMIN' in app.user.roles %}
                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash3"></i> Supprimer s√©lection
                    </button>
                </div>
            </form>
            {% endif %}

    </div>    
    {% endif %}
</div>

        <div class="col-md-4 justify-items-center mt-4">
            {% if 'ROLE_ADMIN' in app.user.roles %}
            
                <a href="{{ path('admin_dashboard') }}" class="btn btn-primary">
                    <i class="bi bi-speedometer2"></i> Acc√©der au Dashboard Admin
                </a>
 
            {% else %}
                <a href="{{ path('user_dashboard') }}" class="btn btn-primary">
                    <i class="bi bi-speedometer2"></i> Acc√©der au Dashboard Utilisateur
                </a>
            {% endif %}
        </div>  
<!-- Inclure DataTables JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#interventions-table').DataTable({
            
            language: {
                url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json" // Traduction en fran√ßais
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            selectAll.addEventListener('click', function () {
                const checkboxes = document.querySelectorAll('input[name="ids[]"]');
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
            });
        }
        const deleteForm = document.getElementById('delete-form');
        const deleteButton = deleteForm.querySelector('button[type="submit"]');

        deleteButton.addEventListener('click', function (e) {
            console.log("click !");
            e.preventDefault();

            const selected = deleteForm.querySelectorAll('input[name="ids[]"]:checked');
            if (selected.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Aucune s√©lection',
                    text: 'Veuillez s√©lectionner au moins une intervention √† supprimer.',
                    confirmButtonText: 'OK'
                });
                return;
            }

            Swal.fire({
                title: '√ätes-vous s√ªr ?',
                text: "Cette action est irr√©versible !",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler'
            }).then((result) => {
                if (result.isConfirmed) {
                    deleteForm.submit();
                }
            });
        });
    });

</script>

{% endblock %}
